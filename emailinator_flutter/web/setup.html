<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Emailinator Setup</title>
  <meta name="description" content="Step-by-step guide to forward school emails to Emailinator.">
  <link rel="icon" type="image/png" href="favicon.png"/>
  <!-- Supabase JS is not required for this page's minimal needs.
       We avoid initializing a JS client/session to prevent broadcasting
       auth events that can conflict with the Flutter app's auth state. -->
  <style>
    :root {
      --bg: #0f172a;         /* slate-900 */
      --panel: #ffffff;
      --muted: #64748b;      /* slate-500 */
      --border: #e2e8f0;     /* slate-200 */
      --accent: #2563eb;     /* blue-600 */
      --accent-50: #eff6ff;  /* blue-50 */
      --success: #16a34a;    /* green-600 */
      --warning: #f59e0b;    /* amber-500 */
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      color: #0f172a;
    }

    /* Header */
    .hero {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 40%, #0f172a 100%);
      color: white;
      padding: 48px 24px;
    }
    .hero-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 32px;
      align-items: center;
      justify-content: space-between;
    }
    .hero h1 { margin: 0 0 8px; font-size: 40px; letter-spacing: -0.02em; }
    .hero p { margin: 0; color: #cbd5e1; font-size: 18px; }

    /* Content */
    .container {
      max-width: 1200px;
      margin: 24px auto 64px;
      padding: 0 24px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(2, 6, 23, 0.06);
    }

    /* Alias box */
    .alias {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 16px;
      background: #f8fafc;  /* slate-50 */
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 8px;
    }
    .alias .label { font-weight: 600; color: #334155; }
    .alias .value { flex: 1; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn {
      appearance: none; border: 1px solid #cbd5e1; background: white; color: #0f172a;
      padding: 10px 14px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
    .btn.primary:hover { filter: brightness(1.05); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Steps */
    .steps { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .step { border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    .step-header { display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: var(--accent-50); border-bottom: 1px solid var(--border); }
    .step-num { width: 34px; height: 34px; border-radius: 999px; background: var(--accent); color: white; display: grid; place-items: center; font-weight: 800; }
    .step-title { font-weight: 800; letter-spacing: -0.01em; }
    .step-sub { color: var(--muted); font-size: 14px; }
    .step-body { padding: 18px; background: white; }
    .callout { padding: 12px; border-radius: 10px; border: 1px solid #dbeafe; background: #eff6ff; color: #1e40af; display: flex; gap: 10px; align-items: flex-start; }
    .tip { padding: 12px; border-radius: 10px; border: 1px solid #fed7aa; background: #fffbeb; color: #78350f; }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }

    /* Screenshot placeholder */
    .screenshot {
      margin-top: 14px;
      width: 100%;
      min-height: 240px;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      display: grid; place-items: center;
      color: #64748b; background: #f8fafc;
    }

    /* Two-column on wide screens */
    @media (min-width: 1100px) {
      .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-inner">
      <div>
        <h1>Forward school emails to Emailinator</h1>
        <p>You’ll need ~2 minutes. Follow the steps below.</p>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="panel" style="padding: 20px 20px 8px;">
      <h2 style="margin: 0;">Your forwarding address</h2>
      <p class="step-sub" style="margin-top: 6px;">Copy this address to add it in Gmail settings.</p>
      <div class="alias">
        <span class="label">Alias:</span>
        <span class="value" id="aliasValue">your.alias@in.emailinator.app</span>
        <button class="btn" id="copyBtn" type="button">Copy</button>
      </div>
      <p class="step-sub" style="margin: 10px 0 0;">Tip: You can pass <code>?alias=</code> in the URL to prefill.</p>
    </section>

    <div style="height: 18px;"></div>

    <section class="grid-2">
      <div class="steps">
        <!-- Step 1 -->
        <article class="step">
          <div class="step-header">
            <div class="step-num">1</div>
            <div>
              <div class="step-title">Add forwarding address</div>
              <div class="step-sub">Gmail → Settings → Forwarding and POP/IMAP</div>
            </div>
          </div>
          <div class="step-body">
            <div class="actions" style="margin-top: 4px; align-items: center;">
              <a id="openGmail" class="btn primary" target="_blank" rel="noopener" href="https://mail.google.com/mail/u/0/?ui=1#inbox">Open Gmail</a>
              <a id="openGmailIntent" class="btn" target="_blank" rel="noopener" href="#" style="display:none;">Open in Chrome (Android)</a>
            </div>
            <div id="gmailHelp" class="step-sub" style="margin-top:8px; color:#475569;"></div>
            <p style="margin:12px 0 0; color:#334155;">Follow these steps to add the address above to Gmail forwarding address</p>
            <div class="screenshot" style="margin-top: 12px; border: 0; padding: 0; aspect-ratio: 16/9; min-height: 0;">
              <iframe
                width="100%"
                height="100%"
                src="https://www.youtube.com/embed/zlyndAJcGl0?rel=0"
                title="Emailinator Gmail Forwarding Setup"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                style="display:block; border:0; border-radius:12px;"
              ></iframe>
            </div>
            <div id="verificationBox" style="display:none; margin-top:12px;"></div>
          </div>
        </article>

        <!-- Step 2 -->
        <article class="step">
          <div class="step-header">
            <div class="step-num">2</div>
            <div>
              <div class="step-title">Set up forwarding rule</div>
              <div class="step-sub">Choose which emails to forward (e.g., school domains)</div>
            </div>
          </div>
          <div class="step-body">
            <p>Create a Gmail filter that matches your school senders and set the action to “Forward to” your Emailinator address.</p>
            <div class="screenshot">Screenshot placeholder: Gmail filter setup</div>
          </div>
        </article>

        <!-- Step 3 -->
        <article class="step">
          <div class="step-header">
            <div class="step-num">3</div>
            <div>
              <div class="step-title">Validate with test emails</div>
              <div class="step-sub">Send a couple of tests and confirm they appear</div>
            </div>
          </div>
          <div class="step-body">
            <p>Send a test message that matches your filter. Then check Emailinator for extracted tasks.</p>
            <div class="tip" style="margin-top: 10px;">If you don’t see a verification banner in Emailinator within a minute, re-check Step 1.</div>
            <div class="screenshot" style="margin-top: 12px;">Screenshot placeholder: Emailinator tasks view</div>
          </div>
        </article>
      </div>

      <aside class="panel" style="padding: 18px;">
        <h3 style="margin-top: 0;">Notes</h3>
        <ul style="margin-top: 8px; color: #334155; line-height: 1.6;">
          <li>You can redo these steps anytime from the app’s Setup screen.</li>
          <li>If you have multiple Gmail accounts, switch to the correct one from the top-right avatar before Step 1.</li>
          <li>We only process messages you choose to forward. You can refine your filter anytime.</li>
        </ul>
      </aside>
    </section>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const aliasParam = qs.get('alias');
    const sbUrl = qs.get('sbUrl');
    const sbAnon = qs.get('sbAnon');

    const aliasEl = document.getElementById('aliasValue');
    const copyBtn = document.getElementById('copyBtn');
    const verificationBox = document.getElementById('verificationBox');

    // Prefill alias from query param immediately if present
    if (aliasParam && aliasEl) aliasEl.textContent = aliasParam;

    // Copy alias helper
    if (copyBtn && aliasEl) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(aliasEl.textContent || '');
          copyBtn.textContent = 'Copied!';
          setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
        } catch (_) {}
      });
    }

    // We avoid creating a Supabase JS client/session here to prevent
    // cross-tab auth broadcasts that can cause parsing issues in Flutter.
    // Instead, we read the existing access_token from localStorage (same origin)
    // and call the REST API directly with fetch.

    // Bridge session from Flutter web (supabase-dart) or Supabase JS if present.
    function findSupabaseTokensFromLocalStorage() {
      try {
        // Common keys: supabase-dart uses 'supabase.auth.token'; supabase-js uses 'sb-<ref>-auth-token'
        const keys = Object.keys(localStorage);
        for (const k of keys) {
          if (k === 'supabase.auth.token' || (k.startsWith('sb-') && k.endsWith('-auth-token'))) {
            const raw = localStorage.getItem(k);
            if (!raw) continue;
            const parsed = JSON.parse(raw);
            const fromCurrent = parsed?.currentSession || parsed?.current_session || parsed?.session;
            const access = parsed?.access_token || fromCurrent?.access_token;
            const refresh = parsed?.refresh_token || fromCurrent?.refresh_token;
            if (access && refresh) {
              return { access_token: access, refresh_token: refresh };
            }
          }
        }
      } catch (_) {}
      return null;
    }

    function decodeJwt(token) {
      try {
        const payload = token.split('.')[1];
        const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(decodeURIComponent(escape(json)));
      } catch (_) { return null; }
    }

    function buildRestUrl(path, params) {
      const url = new URL(sbUrl.replace(/\/$/, '') + '/rest/v1/' + path.replace(/^\//, ''));
      if (params) {
        for (const [k, v] of Object.entries(params)) {
          url.searchParams.set(k, v);
        }
      }
      return url.toString();
    }

    async function apiFetch(path, { method = 'GET', headers = {}, body = null, params = {} } = {}) {
      const tokens = findSupabaseTokensFromLocalStorage();
      if (!tokens?.access_token) return { ok: false, status: 401 };
      const url = buildRestUrl(path, params);
      const res = await fetch(url, {
        method,
        headers: {
          'apikey': sbAnon || '',
          'Authorization': `Bearer ${tokens.access_token}`,
          'Content-Type': 'application/json',
          ...headers,
        },
        body: body ? JSON.stringify(body) : null,
      });
      let data = null;
      try { data = await res.json(); } catch (_) {}
      return { ok: res.ok, status: res.status, data };
    }

    async function loadAliasIfMissing() {
      if (aliasEl.textContent) return;
      const tokens = findSupabaseTokensFromLocalStorage();
      const payload = tokens?.access_token ? decodeJwt(tokens.access_token) : null;
      const userId = payload?.sub || payload?.user_id;
      if (!userId) return;
      const resp = await apiFetch('email_aliases', {
        params: {
          select: 'alias',
          user_id: `eq.${userId}`,
          active: 'eq.true',
          limit: '1',
        }
      });
      if (resp.ok && Array.isArray(resp.data) && resp.data.length > 0 && resp.data[0]?.alias && aliasEl) {
        aliasEl.textContent = resp.data[0].alias;
      }
    }

    async function renderVerification(ver) {
      if (!verificationBox) return;
      verificationBox.style.display = 'block';
      verificationBox.innerHTML = `
        <div class="callout" style="border-color:#86efac;background:#ecfdf5;color:#166534;">
          <div style="flex:1;">
            <strong>Verification email received!</strong><br/>
            Click to open and confirm forwarding in Gmail.
          </div>
          <button id="verifyBtn" class="btn primary">Open verification</button>
        </div>
      `;
      const btn = document.getElementById('verifyBtn');
      if (btn) {
        btn.addEventListener('click', async () => {
          try {
            window.open(ver.verification_link, '_blank', 'noopener');
            if (ver.id) {
              await apiFetch('forwarding_verifications', {
                method: 'PATCH',
                params: { id: `eq.${ver.id}` },
                headers: { 'Prefer': 'return=minimal' },
                body: { clicked_at: new Date().toISOString() },
              });
            }
          } catch (_) {}
        });
      }
    }

    async function pollVerification() {
      const tokens = findSupabaseTokensFromLocalStorage();
      const payload = tokens?.access_token ? decodeJwt(tokens.access_token) : null;
      const userId = payload?.sub || payload?.user_id;
      if (!userId) return;
      const resp = await apiFetch('forwarding_verifications', {
        params: {
          select: 'id,verification_link,clicked_at,created_at',
          user_id: `eq.${userId}`,
          'clicked_at': 'is.null',
          order: 'created_at.desc',
          limit: '1',
        }
      });
      if (resp.ok) {
        const rows = Array.isArray(resp.data) ? resp.data : [];
        const row = rows[0];
        if (row?.verification_link) renderVerification(row);
      }
    }

    // ------- Gmail link helpers (device/browser detection) -------
    function detectEnv() {
      const ua = navigator.userAgent || '';
      const platform = navigator.platform || '';
      const vendor = navigator.vendor || '';
      const isIOS = /iPad|iPhone|iPod/.test(ua) || (/Macintosh/.test(ua) && 'ontouchend' in document);
      const isAndroid = /Android/.test(ua);
      const isChrome = /Chrome|CriOS/.test(ua) && !/Edg|OPR/.test(ua);
      const isSafari = /Safari/.test(ua) && /Apple/.test(vendor) && !/CriOS|FxiOS|EdgiOS/.test(ua);
      const isFirefox = /Firefox|FxiOS/.test(ua);
      const isMobile = isIOS || isAndroid || /Mobile/.test(ua);
      return { ua, platform, isIOS, isAndroid, isChrome, isSafari, isFirefox, isMobile };
    }

    function getGmailDesktopUrl() {
      // Best-effort desktop UI route
      return 'https://mail.google.com/mail/u/0/?ui=1#inbox';
    }

    function getAndroidChromeIntentUrl(url) {
      // Open with Chrome on Android to reduce app deep link takeover
      const encFallback = encodeURIComponent(url);
      return `intent://mail.google.com/mail/u/0/?ui=1#inbox#Intent;scheme=https;package=com.android.chrome;S.browser_fallback_url=${encFallback};end`;
    }

    function renderGmailHelp(env) {
      const help = document.getElementById('gmailHelp');
      if (!help) return;
      let msg = '';
      if (env.isIOS && env.isSafari) {
        msg = 'iOS Safari: Tap aA → Request Desktop Website. If the Gmail app opens, long‑press the button and choose “Open in New Tab.”';
      } else if (env.isIOS && env.isChrome) {
        msg = 'iOS Chrome: Tap ⋯ → Request Desktop Site. If the app opens, long‑press the button and choose “Open in New Tab.”';
      } else if (env.isAndroid && env.isChrome) {
        msg = 'Android Chrome: Tap ⋮ → Desktop site. If the Gmail app opens, use “Open in Chrome (Android)” or long‑press → Open in new tab.';
      } else if (env.isAndroid && env.isFirefox) {
        msg = 'Android Firefox: Tap ⋮ → Request desktop site. If the app opens, long‑press → Open link in new tab.';
      } else if (!env.isMobile) {
        msg = 'Opens Gmail in a new tab.';
      }
      help.textContent = msg;
    }

    function setupGmailLinks() {
      const env = detectEnv();
      const anchor = document.getElementById('openGmail');
      const intent = document.getElementById('openGmailIntent');
      const desktopUrl = getGmailDesktopUrl();
      if (anchor) anchor.href = desktopUrl;
      if (env.isAndroid && env.isChrome && intent) {
        intent.style.display = 'inline-block';
        intent.href = getAndroidChromeIntentUrl(desktopUrl);
        intent.title = 'Try this if the Gmail app opens instead';
      }
      renderGmailHelp(env);
    }

    (async () => {
      // Use existing tokens (from the Flutter app) directly via REST.
      await loadAliasIfMissing();
      await pollVerification();
      // Poll every 10s while on this page
      setInterval(pollVerification, 10000);
      // Configure Gmail links and per-browser help
      setupGmailLinks();
    })();
  </script>
</body>
</html>
