<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <style>
    .htmx-swapping {
        opacity: 0;
        transform: translateX(100%);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    </style>
</head>
<body class="p-4">
    <form method="get" class="space-y-2 mb-4" onsubmit="adjustFilters(this)">
        <div class="space-x-2">
            <label>Due from:
                <input type="date" name="due_date_from" value="{{ due_date_from if due_date_from else '' }}" class="border px-1" />
            </label>
            <label>Due to:
                <input type="date" name="due_date_to" value="{{ due_date_to if due_date_to else '' }}" class="border px-1" />
            </label>
        </div>
        <div>
            <label class="block">Parent requirement levels:</label>
            <select name="parent_requirement_levels" multiple class="border px-1">
                {% for level in ['NONE','OPTIONAL','VOLUNTEER_OPPORTUNITY','MANDATORY'] %}
                    <option value="{{ level }}" {% if level in parent_requirement_levels %}selected{% endif %}>{{ level }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>
                <input type="checkbox" id="include_no_due_date_checkbox" {% if include_no_due_date %}checked{% endif %} /> Include tasks with no due date
            </label>
            <input type="hidden" name="include_no_due_date" id="include_no_due_date_hidden" value="{{ 1 if include_no_due_date else 0 }}" />
        </div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-1 rounded">Filter</button>
    </form>

    <div id="tasks" class="space-y-2">
        {% for task in tasks %}
        <div id="task-{{ task.id }}" class="border p-2 cursor-pointer flex justify-between items-start"
             onclick="openModal(this)"
             data-title="{{ task.title|e }}"
             {% if task.description %}data-description="{{ task.description|e }}"{% endif %}
             {% if task.consequence_if_ignore %}data-consequence="{{ task.consequence_if_ignore|e }}"{% endif %}
             {% if task.parent_action %}data-parent-action="{{ task.parent_action|e }}"{% endif %}
             {% if task.parent_requirement_level %}data-parent-req="{{ task.parent_requirement_level|e }}"{% endif %}
             {% if task.student_action %}data-student-action="{{ task.student_action|e }}"{% endif %}
             {% if task.student_requirement_level %}data-student-req="{{ task.student_requirement_level|e }}"{% endif %}
             {% if task.due_date %}data-due-date="{{ task.due_date }}"{% endif %}
        >
            <div class="flex-1">
                <h3 class="font-semibold">{{ task.title }}</h3>
                {% if task.due_date %}<p class="text-sm text-gray-500">Due: {{ task.due_date }}</p>{% endif %}
                {% if task.parent_requirement_level %}<p class="text-sm">Parent requirement: {{ task.parent_requirement_level }}</p>{% endif %}
            </div>
            <div class="ml-4 flex flex-col items-end space-y-1">
                <div class="space-x-2">
                    <button onclick="event.stopPropagation()" hx-post="/tasks/{{ task.id }}/status" hx-vals='{"status":"done"}' hx-target="#task-{{ task.id }}" hx-swap="outerHTML swap:0.3s" class="bg-green-500 text-white px-2 py-1 rounded">Done</button>
                    <button onclick="event.stopPropagation()" hx-post="/tasks/{{ task.id }}/status" hx-vals='{"status":"dismissed"}' hx-target="#task-{{ task.id }}" hx-swap="outerHTML swap:0.3s" class="bg-gray-500 text-white px-2 py-1 rounded">Dismiss</button>
                </div>
                <div class="flex space-x-2 text-sm">
                    <a onclick="event.stopPropagation()" href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ task.title|urlencode }}{% if task.due_date %}&dates={{ task.due_date|replace('-', '') }}/{{ task.due_date|replace('-', '') }}{% endif %}" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Google_Calendar_icon_%282020%29.svg" alt="Google Calendar" class="w-5 h-5">
                    </a>
                    <a onclick="event.stopPropagation()" href="data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0ASUMMARY:{{ task.title|urlencode }}{% if task.due_date %}%0ADTSTART;VALUE=DATE:{{ task.due_date|replace('-', '') }}%0ADTEND;VALUE=DATE:{{ task.due_date|replace('-', '') }}{% endif %}%0AEND:VEVENT%0AEND:VCALENDAR" download="{{ task.title|replace(' ', '_') }}.ics">
                        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/apple/apple-original.svg" alt="Apple Calendar" class="w-5 h-5">
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" onclick="if (event.target === this) closeModal()">
        <div class="bg-white p-4 rounded w-11/12 max-w-md">
            <h2 class="text-xl font-bold mb-2" id="modal-title"></h2>
            <p id="modal-description" class="mb-2 hidden"></p>
            <p id="modal-parent-action" class="mb-2 hidden"><strong>Parent action:</strong> <span></span></p>
            <p id="modal-parent-requirement" class="mb-2 hidden"><strong>Parent requirement:</strong> <span></span></p>
            <p id="modal-student-action" class="mb-2 hidden"><strong>Student action:</strong> <span></span></p>
            <p id="modal-student-requirement" class="mb-2 hidden"><strong>Student requirement:</strong> <span></span></p>
            <p id="modal-consequence" class="mb-2 hidden"><strong>Consequence if ignored:</strong> <span></span></p>
            <p id="modal-due-date" class="mb-2 hidden"><strong>Due:</strong> <span></span></p>
            <div class="text-right">
                <button class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
<script>
function adjustFilters(form) {
    if (!form.due_date_from.value) {
        form.due_date_from.removeAttribute('name');
    }
    if (!form.due_date_to.value) {
        form.due_date_to.removeAttribute('name');
    }
    document.getElementById('include_no_due_date_hidden').value = document.getElementById('include_no_due_date_checkbox').checked ? '1' : '0';
    return true;
}

function setField(id, value, useSpan) {
    const el = document.getElementById(id);
    if (value) {
        if (useSpan) {
            el.querySelector('span').textContent = value;
        } else {
            el.textContent = value;
        }
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

function openModal(el) {
    document.getElementById('modal-title').textContent = el.dataset.title || '';
    setField('modal-description', el.dataset.description);
    setField('modal-parent-action', el.dataset.parentAction, true);
    setField('modal-parent-requirement', el.dataset.parentReq, true);
    setField('modal-student-action', el.dataset.studentAction, true);
    setField('modal-student-requirement', el.dataset.studentReq, true);
    setField('modal-consequence', el.dataset.consequence, true);
    setField('modal-due-date', el.dataset.dueDate, true);
    document.getElementById('modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}
</script>
</body>
</html>
