<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tasks [{{ user }}]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
    .htmx-swapping {
        opacity: 0;
        transform: translateX(100%);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    </style>
</head>
<body class="p-4">
    <form method="get" class="space-y-2 mb-4" onsubmit="adjustFilters(this)">
        <input type="hidden" name="user" value="{{ user }}" />
        <input type="hidden" name="api_key" value="{{ api_key }}" />
        <div class="flex items-center space-x-2">
            <label>Due:</label>
            <input type="text" id="due_date_range" class="border px-1 w-72" />
            <button type="button" class="bg-gray-500 text-white px-2 py-1 rounded" onclick="openSettings()">Settings</button>
        </div>
        <input type="hidden" name="due_date_from" id="due_date_from" value="{{ due_date_from if due_date_from else '' }}" />
        <input type="hidden" name="due_date_to" id="due_date_to" value="{{ due_date_to if due_date_to else '' }}" />
        {% for level in parent_requirement_levels %}
        <input type="hidden" name="parent_requirement_levels" value="{{ level }}" />
        {% endfor %}
        <input type="hidden" name="include_no_due_date" id="include_no_due_date_hidden" value="{{ 1 if include_no_due_date else 0 }}" />
    </form>

    <div id="tasks" class="space-y-2">
        {% for task in tasks %}
        <div id="task-{{ task.id }}" class="border p-2 cursor-pointer flex justify-between items-start"
             onclick="openModal(this)"
             data-title="{{ task.title|e }}"
             {% if task.description %}data-description="{{ task.description|e }}"{% endif %}
             {% if task.consequence_if_ignore %}data-consequence="{{ task.consequence_if_ignore|e }}"{% endif %}
             {% if task.parent_action %}data-parent-action="{{ task.parent_action|e }}"{% endif %}
             {% if task.parent_requirement_level %}data-parent-req="{{ task.parent_requirement_level|e }}"{% endif %}
             {% if task.student_action %}data-student-action="{{ task.student_action|e }}"{% endif %}
             {% if task.student_requirement_level %}data-student-req="{{ task.student_requirement_level|e }}"{% endif %}
             {% if task.due_date %}data-due-date="{{ task.due_date }}"{% endif %}
        >
            <div class="flex-1">
                <h3 class="font-semibold">{{ task.title }}</h3>
                {% if task.due_date %}<p class="text-sm text-gray-500">Due: {{ task.due_date }}</p>{% endif %}
                {% if task.parent_requirement_level %}<p class="text-sm">Parent requirement: {{ task.parent_requirement_level }}</p>{% endif %}
            </div>
            <div class="ml-4 flex flex-col items-end space-y-1">
                <div class="space-x-2">
                    <button onclick="event.stopPropagation()" hx-post="/tasks/{{ task.id }}/status?user={{ user }}&api_key={{ api_key }}" hx-vals='{"status":"done"}' hx-target="#task-{{ task.id }}" hx-swap="outerHTML swap:0.3s" class="bg-green-500 text-white px-2 py-1 rounded">Done</button>
                    <button onclick="event.stopPropagation()" hx-post="/tasks/{{ task.id }}/status?user={{ user }}&api_key={{ api_key }}" hx-vals='{"status":"dismissed"}' hx-target="#task-{{ task.id }}" hx-swap="outerHTML swap:0.3s" class="bg-gray-500 text-white px-2 py-1 rounded">Dismiss</button>
                </div>
                <div class="flex space-x-2 text-sm">
                    <a onclick="event.stopPropagation()" href="https://calendar.google.com/calendar/render?action=TEMPLATE&text={{ task.title|urlencode }}{% if task.due_date %}&dates={{ task.due_date|replace('-', '') }}/{{ task.due_date|replace('-', '') }}{% endif %}" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Google_Calendar_icon_%282020%29.svg" alt="Google Calendar" class="w-5 h-5">
                    </a>
                    <a onclick="event.stopPropagation()" href="data:text/calendar;charset=utf8,BEGIN:VCALENDAR%0AVERSION:2.0%0ABEGIN:VEVENT%0ASUMMARY:{{ task.title|urlencode }}{% if task.due_date %}%0ADTSTART;VALUE=DATE:{{ task.due_date|replace('-', '') }}%0ADTEND;VALUE=DATE:{{ task.due_date|replace('-', '') }}{% endif %}%0AEND:VEVENT%0AEND:VCALENDAR" download="{{ task.title|replace(' ', '_') }}.ics">
                        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/apple/apple-original.svg" alt="Apple Calendar" class="w-5 h-5">
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" onclick="if (event.target === this) closeModal()">
        <div class="bg-white p-4 rounded w-11/12 max-w-md">
            <h2 class="text-xl font-bold mb-2" id="modal-title"></h2>
            <p id="modal-description" class="mb-2 hidden"></p>
            <p id="modal-parent-action" class="mb-2 hidden"><strong>Parent action:</strong> <span></span></p>
            <p id="modal-parent-requirement" class="mb-2 hidden"><strong>Parent requirement:</strong> <span></span></p>
            <p id="modal-student-action" class="mb-2 hidden"><strong>Student action:</strong> <span></span></p>
            <p id="modal-student-requirement" class="mb-2 hidden"><strong>Student requirement:</strong> <span></span></p>
            <p id="modal-consequence" class="mb-2 hidden"><strong>Consequence if ignored:</strong> <span></span></p>
            <p id="modal-due-date" class="mb-2 hidden"><strong>Due:</strong> <span></span></p>
            <div class="text-right">
                <button class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" onclick="if (event.target === this) closeSettings()">
        <div class="bg-white p-4 rounded w-11/12 max-w-md">
            <h2 class="text-xl font-bold mb-2">Settings</h2>
            <div class="mb-2">
                <label class="block">Parent requirement levels:</label>
                <select id="settings_parent_requirement_levels" multiple class="border px-1 w-full">
                    {% for level in ['NONE','OPTIONAL','VOLUNTEER_OPPORTUNITY','MANDATORY'] %}
                    <option value="{{ level }}" {% if level in parent_requirement_levels %}selected{% endif %}>{{ level }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label>
                    <input type="checkbox" id="settings_include_no_due_date" {% if include_no_due_date %}checked{% endif %} /> Include tasks with no due date
                </label>
            </div>
            <div class="text-right space-x-2">
                <button class="bg-gray-500 text-white px-3 py-1 rounded" onclick="closeSettings()">Cancel</button>
                <button class="bg-blue-500 text-white px-3 py-1 rounded" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>
<script>
function adjustFilters(form) {
    if (!form.due_date_from.value || !form.due_date_to.value) {
        form.due_date_from.removeAttribute('name');
        form.due_date_to.removeAttribute('name');
    }
    return true;
}

function setField(id, value, useSpan) {
    const el = document.getElementById(id);
    if (value) {
        if (useSpan) {
            el.querySelector('span').textContent = value;
        } else {
            el.textContent = value;
        }
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

function openModal(el) {
    document.getElementById('modal-title').textContent = el.dataset.title || '';
    setField('modal-description', el.dataset.description);
    setField('modal-parent-action', el.dataset.parentAction, true);
    setField('modal-parent-requirement', el.dataset.parentReq, true);
    setField('modal-student-action', el.dataset.studentAction, true);
    setField('modal-student-requirement', el.dataset.studentReq, true);
    setField('modal-consequence', el.dataset.consequence, true);
    setField('modal-due-date', el.dataset.dueDate, true);
    document.getElementById('modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

function openSettings() {
    document.getElementById('settings-modal').classList.remove('hidden');
}

function closeSettings() {
    document.getElementById('settings-modal').classList.add('hidden');
}

async function saveSettings() {
    const select = document.getElementById('settings_parent_requirement_levels');
    const levels = Array.from(select.selectedOptions).map(o => o.value);
    const include = document.getElementById('settings_include_no_due_date').checked ? '1' : '0';
    const params = new URLSearchParams({user: '{{ user }}', api_key: '{{ api_key }}'});
    const formData = new URLSearchParams();
    for (const lvl of levels) formData.append('parent_requirement_levels', lvl);
    formData.append('include_no_due_date', include);
    await fetch(`/user/preferences?${params}`, {method: 'POST', body: formData});

    const form = document.querySelector('form');
    form.querySelectorAll('input[name="parent_requirement_levels"]').forEach(e => e.remove());
    for (const lvl of levels) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'parent_requirement_levels';
        input.value = lvl;
        form.appendChild(input);
    }
    document.getElementById('include_no_due_date_hidden').value = include;

    closeSettings();
    form.requestSubmit();
}

document.addEventListener('DOMContentLoaded', function() {
    const fromInput = document.getElementById('due_date_from');
    const toInput = document.getElementById('due_date_to');
    let lastFrom = fromInput.value;
    let lastTo = toInput.value;
    flatpickr('#due_date_range', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        defaultDate: [lastFrom, lastTo],
        onClose: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
                fromInput.value = instance.formatDate(selectedDates[0], 'Y-m-d');
                toInput.value = instance.formatDate(selectedDates[1], 'Y-m-d');
                lastFrom = fromInput.value;
                lastTo = toInput.value;
                document.querySelector('form').requestSubmit();
            } else {
                if (lastFrom && lastTo) {
                    instance.setDate([lastFrom, lastTo], false);
                } else {
                    instance.clear();
                }
            }
        }
    });
});
</script>
</body>
</html>
